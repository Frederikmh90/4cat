<li id="post-{{ post.id }}"{% if post.thread_id == post.id %} class="op"{% endif %}>    
	<header>
		<!-- Mandatory metadata -->
		<span title="Author" class="author">
		{% if post.author|length > 20 %}
			{{ post.author[:17] + '...' }}
		{% else %}
			{{ post.author }}
		{% endif %}
		</span>
		<span title="Thread ID" class="thread_id">{% if is_local %}<a href="/explorer/thread/{{ datasource }}/{{ board }}/{{ post.thread_id }}">{{ post.thread_id }}</a>{% else %}{{ post.thread_id }}{% endif %}</span>
		<span title="Post ID" class="post_id">{{ post.id }}</span>
		{% if post.timestamp is integer %}
			<span title="Date" class="datetime">{{ post.timestamp|datetime('%Y-%m-%d %H:%M') }}</span>
		{% else %}
			<span title="Date" class="datetime">{{ post.timestamp }}</span>
		{% endif %}
		<!-- Custom metadata -->
		{% if custom_fields %}

			{% for custom_field in custom_fields %}
				{% if post.get(custom_field, "") %}
					{% set custom_value = post.get(custom_field) %}
					{% if custom_value|length > 100 %}
						{% set custom_value = custom_value[:97] + '...' %}
					{% endif %}
					{% if custom_value and custom_value != "None" %}
						<span title="{{ custom_field }}: {{ custom_value }}" class="{{ custom_field }}">{{ custom_value }}</span>
					{% endif %}
				{% endif %}
			{% endfor %}
		{% endif %}

	</header>
	<!-- Optional image(s) -->
	{% if "images" in post %}
		{% set images = post.images %}
	{% elif custom_fields and "images" in custom_fields %}
		{% set images = post[custom_fields["images"].get("field")] %}

		<!-- Prepend a URL to the image filenames -->
		{% if images and "url_root" in custom_fields["images"] %}
			{% set images = custom_fields["images"]["url_root"] + images %}
			
			<!-- Replace board variable of image URL -->
			{% if "{{board}}" in images %}
				{% set images = images | post_field(post) %}
			{% endif %}
		{% endif %}

	{% endif %}

	<!-- Possible external link -->
	{% if custom_fields and "external_url" in custom_fields %}
		{% set external_url = custom_fields.external_url | post_field(post, board) %}
		<a href="{{ external_url }}" target="_blank"><span class="external-url"><i class="fas fa-external-link-alt"></i></span></a>
	{% endif %}

	<!-- Post content-->
	<article>
	{% if images %}
	<a href="{{ images }}" target="_blank" rel="external" class="has_image">
		<img src="{{ images }}">
	</a>
	{% endif %}
	<span class="post-content">
		{{ post.body|safe }}
	</span>

	</article>

	<!-- Annotations -->
	<div class="post-annotations">
		
		{% if annotation_fields %}
			{% set old_annotations = None %}

			{% if annotations and post.id in annotations %}
				{% set old_annotations = annotations[post.id] %}
			{% endif %}

			{% for field in annotation_fields %}

				{% set type = annotation_fields[field]["type"] %}
				{% set label = annotation_fields[field]["label"] %}
				{% set old_annotation = "" %}

				{% if old_annotations and label in old_annotations %}
					{% set old_annotation = old_annotations[label] %}
				{% endif %}
				
				<div class="post-annotation field-{{ field }} {{ type }}"><label class="annotation-label">{{ label }}</label>

				{% if type == 'text' %}
					<input type="text" class="post-annotation-input text-{{ field }}" value="{{ old_annotation }}">

				{% elif type == 'textarea' %}
					<textarea class="post-annotation-input textarea-{{ field }}">{{ old_annotation }}</textarea>

				{% elif type == 'dropdown' %}
					<select class="post-annotation-options select-{{ type }}" id="{{ field }}">
					<option class='post-annotation-input' value=''></option>

					{% for option in annotation_fields[field]["options"] %}
						{% set option_id = option.keys() | list %}
						{% set option_label = option.values() | list %}
						<option class="post-annotation-input option-{{ option_id[0] }}" id="option-{{ option_id[0] }}" value="{{ option_label[0] }}" {% if option_label[0] == old_annotation %}selected{% endif %}>{{ option_label[0] }}</option>
					{% endfor %}
					</select>

				{% elif type == 'checkbox' %}
					<div class='post-annotation-options checkboxes-{{ field }}'>
						
					{% for option in annotation_fields[field]["options"] %}
						{% set option_id = option.keys() | list %}
						{% set option_label = option.values() | list %}
						{% set checked = "checked" if old_annotation and option_label[0] in old_annotation else "" %}

						<input type='checkbox' class='post-annotation-input option-{{ option_id[0] }}' id='option-{{ post.id }}-{{ option_id[0] }}' value='{{ option_label[0] }}' {{ checked }}><label for='option-{{ post.id }}-{{ option_id[0] }}'>{{ option_label[0] }}</label>
					{% endfor %}
					</div>
				{% endif %}

				</div>
			{% endfor %}
		{% endif %}
	</div>

</li>
